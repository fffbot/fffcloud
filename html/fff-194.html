
<!DOCTYPE html>
<html>
 <head>
    <title>Friday Facts #194 - Automated combinator pipeline | Factorio</title>
    <link href="/static/img/favicon.ico" rel="icon" type="image/x-icon"/>
    <link href="/static/img/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="/static/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css"/>
    <link href="/static/css/factorio.css" rel="stylesheet" type="text/css"/>
    <link href="/static/lightbox/css/lightbox.css" rel="stylesheet" type="text/css"/>
    <link href="/blog/rss" rel="alternate" title="Recent Blog Posts" type="application/atom+xml">
    <meta name="viewport" content="width=device-width">
    
    
 </head>
 <body style="background: rgb(22, 22, 22) url(/static/img/stressed_linen_texture.png) repeat 0 0;'">
  <div class="container header" style="margin-top: 30px;">

    <!-- top row -->
   <div class="row" style="margin-bottom: 30px;">
     <div class="span4">
       <a href="/"><img src="/static/img/factorio-logo.png" style="margin-top: 10px;"/></a>
     </div>
    <div class="span8 span8-navbar" style="margin-top: 10px;">
     <div class="user-controls">
      
           <a href="/login">log in</a>
           <a href="/signup">sign up</a>
      
     </div>

     

      

     <div class="navbar">
      <ul class="nav">
        
          
            <li >

            
              <a href=/
                 
              > Home </a>
            

            </li>
        
          
            <li >

            
              <a href=/store
                  style="color: #ff7200;" 
              > Merch </a>
            

            </li>
        
          
            <li  class="custom-dropdown" >

            

              <a class="custom-dropdown-toggle"
                data-toggle="dropdown"
                href="/game-overview"
                
                role="button">
                Game
              </a>

              <ul class="custom-dropdown-menu" role="menu">
                
                  <li role="presentation">
                    <a href=/starter-page>
                      Starter Page
                    </a>
                  </li>
                
                  <li role="presentation">
                    <a href=/screenshots>
                      Screenshots
                    </a>
                  </li>
                
                  <li role="presentation">
                    <a href=/videos>
                      Videos
                    </a>
                  </li>
                
                  <li role="presentation">
                    <a href=/content>
                      Content
                    </a>
                  </li>
                
                  <li role="presentation">
                    <a href=/modding>
                      Modding
                    </a>
                  </li>
                
                  <li role="presentation">
                    <a href=/team>
                      Team
                    </a>
                  </li>
                
              </ul>

            

            </li>
        
          
            <li  class="custom-dropdown" >

            

              <a class="custom-dropdown-toggle"
                data-toggle="dropdown"
                href="/support-overview"
                
                role="button">
                Support
              </a>

              <ul class="custom-dropdown-menu" role="menu">
                
                  <li role="presentation">
                    <a href=/help>
                      Help
                    </a>
                  </li>
                
                  <li role="presentation">
                    <a href=/faq>
                      FAQ
                    </a>
                  </li>
                
                  <li role="presentation">
                    <a href=/press-and-youtube>
                      Press and Youtube
                    </a>
                  </li>
                
                  <li role="presentation">
                    <a href=/community>
                      Community
                    </a>
                  </li>
                
                  <li role="presentation">
                    <a href=/partners>
                      Partners
                    </a>
                  </li>
                
                  <li role="presentation">
                    <a href=/credits>
                      Credits
                    </a>
                  </li>
                
              </ul>

            

            </li>
        
          
            <li >

            
              <a href=https://forums.factorio.com/
                 
              > Forums </a>
            

            </li>
        
          
            <li >

            
              <a href=/contact
                 
              > Contact </a>
            

            </li>
        

      </ul>
     </div>
     </div>
    </div>
   </div>
  <div class="container">
    <noscript>
      <div class="alert alert-block alert-error" style="font-weight: bold; ">
        Javascript is required for proper functioning of these web pages.
      </div>
    </noscript>

    
        
    

    
        
    

    

    

<div class="row">
  <div class="span12 blog-post">
    <h2 style="margin-top: 20px; margin-bottom:5px;">
      Friday Facts #194 - Automated combinator pipeline
    </h2>

    <div style="font-size: 11px;">Posted by V453000 on 2017-06-09, <a href="/blog/">all posts</a></div>

    <p>
    <p>
Hello inhabitants of a remote and unexplored planet full of life, richness and natural resources.
</p>
<p>
The group of entities we are bringing to high resolution currently is the combinators. The main problem with them is the amount of shifting values needed, so we used a specific workflow which I will try to show and explain today. Some of the parts have already been described in <a href="https://www.factorio.com/blog/post/fff-146">FFF 146</a>, so I will only mention what is necessary for this article.
</p>
<p>
Please fasten your belt as this will be a ride full of automation.
</p>

<p style="text-align: center; margin:auto; margin-top:20px; margin-bottom: 20px;">
<img style="vertical-align: top;" src="https://cdn.factorio.com/assets/img/blog/fff-194-00-automation-overview.png">
</p>
 
<h4>01 - Blender</h4>
<p>
Here it all starts. As you might already know, almost everything in Factorio comes from 3D models created in Blender. This time I already had the combinator models ready as we updated them relatively recently (in 0.13).
</p>

<p style="text-align: center; margin:auto; margin-top:20px; margin-bottom: 20px;">
<img style="vertical-align: top;" src="https://cdn.factorio.com/assets/img/blog/fff-194-01-Blender-model-v3.png">
</p>
 
<p>
In 0.15, we added many new operations for the combinators, which required additional display graphics, some of them having quite complicated shapes. For some obscure reason I was afraid that the old matrix of lightbulbs wouldn’t be able to represent such detailed symbols so I increased the resolution from 7x7 to 15x15. I wasn’t too happy with the result, but at that point time was a big pressing factor so we just kept it. The thin lines however lose quite a bit of the granular display nature and they behave quite poorly when zooming out.
 </p>

<p style="text-align: center; margin:auto; margin-top:20px; margin-bottom: 20px;">
<img style="vertical-align: top;" src="https://cdn.factorio.com/assets/img/blog/fff-194-02-hr-combinator-displays.png">
</p>
 
<p>
Now when I had the chance of revisiting combinators, I tried to redo the symbols with 9x9 as I was thinking “Well, I probably abandoned 7x7 for a reason so let’s not try that.” However, I quickly found out that it’s actually very easy to fit all of the symbols in 9x9 so I tried 7x7 out of curiosity. I was very surprised to see that it’s actually totally fine and there was no reason to abandon the 7x7 grid. So, here you can see all the old-new displays.
</p>

<p style="text-align: center; margin:auto; margin-top:20px; margin-bottom: 20px;">
<img style="vertical-align: top;" src="https://cdn.factorio.com/assets/img/blog/fff-194-03-hr-displays-spritesheet.png">
</p>

<p> 
Once the 3D models are prepared, I could get into rendering them very fast just by changing a handful of values. You can see that the original scene was already prepared for resolution doubling.
 </p>

<p style="text-align: center; margin:auto; margin-top:20px; margin-bottom: 20px;">
<img style="vertical-align: top;" src="https://cdn.factorio.com/assets/img/blog/fff-194-04-resolution.png">
</p>

<p>
It’s worth mentioning how the rendering system actually works. The combinator objects are split into layers, separating horizontal and vertical models (because they are different due to projection), and rotating them between frames 1 and 2 in time.
</p> 

<p style="text-align: center; margin:auto; margin-top:20px; margin-bottom: 20px;">
<img style="vertical-align: top;" src="https://cdn.factorio.com/assets/img/blog/fff-194-05-layers-v2.png">
</p>

<p>
With this, we can assign RenderLayers to combine the layers and output what we want.
The next step is naming the outputs correctly and putting them in their own folders - for that we use a fake rendering scene which has only one purpose - collect the RenderLayers from the real model scenes, and save them to disk.
</p>
 
<p style="text-align: center; margin:auto; margin-top:20px; margin-bottom: 20px;">
<img style="vertical-align: top;" src="https://cdn.factorio.com/assets/img/blog/fff-194-06-saving-nodes.png">
</p>

<p> 
Once that all works we just need to press one button to output everything.
</p>

<p style="text-align: center; margin:auto; margin-top:20px; margin-bottom: 20px;">
<img style="vertical-align: top;" src="https://cdn.factorio.com/assets/img/blog/fff-194-07-animation-button.gif">
</p>
 
<h4>02 - Photoshop</h4>

<p>
Many things can be achieved in a 3D program, but human touch in Photoshop is always a very vital step for vast majority of our graphics.
The main technical criteria for Photoshop output is the ability to import the working file into After Effects as separate layers. I will show why this is necessary later.
</p>

<p>
Since there are 12 combinator variations, maintaining your 12 PSD files would become a pain sooner or later for many reasons, so I import everything into one big file.
Here I typically space the imported layers out so that I can see and edit everything at the same time. We will center them back later. This way I can paint on all of them together which not only saves time otherwise spent by switching files, but it also lets me see the differences and make sure I'm not overdoing it on some of them.
</p>

<p>
Typically we duplicate the layers twice (groups in this case) and blend them with Screen and Multiply modes. Of course the blending only happens in carefully hand-painted spots, which gets us to the outputs we are trying to get out of Photoshop - masks which control the correction seen above. This is how one of them looks like:
</p>

<p style="text-align: center; margin:auto; margin-top:20px; margin-bottom: 20px;">
<img style="vertical-align: top;" src="https://cdn.factorio.com/assets/img/blog/fff-194-09-Ps-edit.gif">
</p>

<p>
A special thing to mention, we also generate ground integration with Drop Shadow functions in Photoshop, which has to be merged in a single layer so it could be exported. The problem with this is that it has to be done manually so again doing it just once in one big photoshop file is faster than in 12 different files.
</p>

<p style="text-align: center; margin:auto; margin-top:20px; margin-bottom: 20px;">
<img style="vertical-align: top;" src="https://cdn.factorio.com/assets/img/blog/fff-194-09-ScreenMask.png">
</p>

<h4>03 - After Effects</h4>

<p>
The place where everything fits together is After Effects. Here we bring all of the rendered outputs from Blender together with the masks exported from Photoshop, and with some system combine them into image sequences which will later be processed by python scripts.
</p>

<p style="text-align: center; margin:auto; margin-top:20px; margin-bottom: 20px;">
<img style="vertical-align: top;" src="https://cdn.factorio.com/assets/img/blog/fff-194-10-Ae-02-Ps-EDIT.png">
</p>

<p> 
The obvious thing to do first are the combinator sprites, this is using the quite typical system of taking the rendered sprite, masking it and duplicating it to screen/multiply blend itself, of course feeding it the mask from Photoshop. The Photoshop masks are imported directly from the PSD file as layers, which is why it's important to have them ready for this step. In After Effects they have to be centered back to fit the render, to compensate for the spacing in Photoshop.
</p>

<p>
After that it’s just doing the same for all combinator types, rotations and shadows. The pipeline can look like this:
</p>

<ol>
<li>Render - raw footage directly from Blender
<li>Ps-EDIT - applying the Photoshop masks
<li>Sequence - final positioning tweaks
<li>Output - separating the sequence into separate outputs for each combinator type (arithmetic, decider, constant)
</ol>

<p>
The exact same applies for shadows. Rotations, dance!
</p>

<p style="text-align: center; margin:auto; margin-top:20px; margin-bottom: 20px;">
<img style="vertical-align: top;" src="https://cdn.factorio.com/assets/img/blog/fff-194-11-rotations.gif">
</p>

<p> 
This After Effects pipeline is quite typical for all of our entities. The system can differ in complexity but it’s something similar. The special part here is that combinators have a huge amount of shifting values for the wire connections in Lua, and we need to somehow define them. To be more specific, we have:
</p>
<ul>
<li>Red wire input
<li>Green wire input
<li>Red wire output
<li>Green wire output
<li>Red wire input shadow
<li>Green wire input shadow
<li>Red wire output shadow
<li>Green wire output shadow
</ul>
<p>
Even though the constant combinator doesn’t have any input, it still totals 80 shifting values just for the wire connections, not even mentioning shiftings for the displays, activity LEDs and the combinator graphics themselves. Doing each point manually would be insanely tedious, time consuming and to redo it you simply have to do it all over again, at which point you might as well just go hang yourself with a red and green cable.
</p>

<p style="text-align: center; margin:auto; margin-top:20px; margin-bottom: 20px;">
<img style="vertical-align: top;" src="https://cdn.factorio.com/assets/img/blog/fff-194-lazy-bastard.png">
</p>

<p>
When we combine it all, in total we exceed 111 shiftings. Because we are proper Lazy Bastards, we have a special pipeline to prevent doing all this manually. (Automation, anyone?)
 </p>
<p>
In After Effects we take the centered sequence of combinator sprites and desaturate them. On top we put 1 pixel indicators for the wire connection points. The result looks like this, note the small colourful spots. The gray arrow is just for debug and to prevent mistakes.
</p>

<p style="text-align: center; margin:auto; margin-top:20px; margin-bottom: 20px;">
<img style="vertical-align: top;" src="https://cdn.factorio.com/assets/img/blog/fff-194-12-Ae-shifting-output.png">
</p>
 
<h4>04 - Shifting processing</h4>
 
<p>
The previous picture alone isn’t very useful as we do not have a tool which would just calculate the shifting outright so we need to process the pictures and filter them by colour. Each of the coloured pixels is going to be split into one file which results in a funny picture which has just 1 pixel for you to find in case you want to have a look manually. There is a simple colour code for the filtering:
</p>

<p style="text-align: center; margin:auto; margin-top:20px; margin-bottom: 20px;">
<img style="vertical-align: top;" src="https://cdn.factorio.com/assets/img/blog/fff-194-13-shifting-processing.png">
</p>

<p> 
The aim is to separate them all into their own exclusive folders, where they will be waiting eagerly to be processed and spat out by the next assembling machine script…
 </p>

<h4>05 - Spritesheeter</h4>
 
<p>
We already mentioned multiple times that we are using an universal python script to crop images and calculate the shifting required to re-center the cropped picture. This is generally useful simply because it’s cropping the data to the minimum possible bounding box, minimizing the file sizes of the game and leaving less work for texture Atlas cropping during loading time.
</p>
<p>
Now we can use this tool to calculate the wire shiftings for the combinators from the single-pixel images from the previous step. This doesn’t happen magically by itself, we still need to tell Spritesheeter what to do, so we can just casually generate the .bat command for Spritesheeter by another python script. Spritesheeter devours its prey per folder, which is why we separated each of the shifting pictures into their own folder. The output is 80 text files which look something like this, focus is of course on the 'shift = ...' line.
 
<p style="text-align: center; margin:auto; margin-top:20px; margin-bottom: 20px;">
<img style="vertical-align: top;" src="https://cdn.factorio.com/assets/img/blog/fff-194-14-spritesheeter-output.png">
</p>
 
<p>
Note: the real combinator sprites, activity led and display sprites also go through Spritesheeter, outputting whole spritesheets where possible, like for example those two.
</p>

<p style="text-align: center; margin:auto; margin-top:20px; margin-bottom: 20px;">
<img style="vertical-align: top;" src="https://cdn.factorio.com/assets/img/blog/fff-194-15-decider-combinator.png">
</p>

<p style="text-align: center; margin:auto; margin-top:20px; margin-bottom: 20px;">
<img style="vertical-align: top;" src="https://cdn.factorio.com/assets/img/blog/fff-194-16-decider-combinator-shadow.png">
</p>
 
<h4>06 - Lua generation</h4>
<p>
If you ever looked into entities.lua and searched for combinators, you probably noticed that it has quite a bit of code. More specifically, whole file has about 12,500 lines. When we separated combinator pictures (not even the whole code), it dropped to 10,500. That’s 2 000 lines of Lua mess to define the new graphics in. It’s safe to assume that it could take me over 2 days to do all this manually so I decided to generate the whole combinator-pictures.lua with another python script automatically.
</p>
<p>
Since I don’t have that much programming experience, I obviously quickly discovered that it isn’t as easy as I imagined it to be, and I quickly got into readability problems so I had to do some code cleaning up because I just got absolutely lost in it at one point. Even now it still has some messy parts, but overall it was a quite straight forward process.
</p>

<p style="text-align: center; margin:auto; margin-top:20px; margin-bottom: 20px;">
<img style="vertical-align: top;" src="https://cdn.factorio.com/assets/img/blog/fff-194-17-lua-generation.png">
</p>

<p> 
It took me about 4 days it probably took a bit longer (about 1-2 days) than doing it manually, although if I had to redo just half once, it might have already evened out, but that’s all just guessing. Even fixing mistakes and errors is much easier as I can just fix a few scripts and re-generate the whole thing within seconds. 
Most importantly, I learned a lot of new things, and we can reuse the processing pipeline in similar entities like the electric poles or circuit connector module (the yellow box which appears when you connect something to circuit network), and many others.
</p>
 
<h4>07 - Copy to Factorio</h4>
 
<p>
We have pictures and code but we need to put all these files in the game. Taking the files manually and putting them into the game is not terribly hard, but you can forget some files, place them in wrong locations, or the folder/naming system between the game and the working directories can simply be different. So it’s very convenient to write another script which actually copies the files to the local git repository, after that it’s just about starting the game and seeing how it works.
</p>

<h4>08 - In the game</h4>
 
<p>
Of course the code seemed to be correct by eyeballing it, but the game is stubborn about syntax and all those unimportant things so I had to do some fixes. This was a repetitive process between editing the 06-Lua generator and putting the files into the game, sometimes even having to re-generate sequences from After Effects and running the whole processing pipeline again.
</p>
<p> 
After doing this a few times it was time for automation so I added a script which automatically triggers all of the 04-07 scripts, letting me to just fix issues and see them in action with just one double-click.
</p>

<p style="text-align: center; margin:auto; margin-top:20px; margin-bottom: 20px;">
<img style="vertical-align: top;" src="https://cdn.factorio.com/assets/img/blog/fff-194-18-combinators.png">
</p>

<h4>Conclusion</h4>
 
<p>
The whole process isn’t exactly short, but automating the steps helps so much, especially when we get to the last step of really making it work right. At that point it is extremely important to be able to say “Can we change this, can we improve that?” and your answer is “Yeah, just change these two things and let it re-generate.” It lets you focus on quality instead of thinking how much time would it take to do all the process manually again, and I really enjoy working this way, not to mention that every time I learn something new to make the tools even better and faster next time. Doesn’t that remind you of some game?
</p>

<h4>Community spotlight</h4>

<p>While we're on the topic of combinators and automation, Reddit user /u/mgabor has spent the last month working on an automated way of importing MIDI to Factorio as programmable speaker songs, introducing <a href="http://miditorio.com/">MIDItorio</a>.
</p>
<p style="text-align: center; margin:auto; margin-top:20px; margin-bottom: 20px;">
<iframe width="896" height="504" src="https://www.youtube.com/embed/wOfsikccYvw" frameborder="0" allowfullscreen></iframe>
</p>
<p>
Hopefully this article was interesting for you, let us know what you think on our <a href="https://forums.factorio.com/49547">forum</a>.
</p>
    </p>



    <div class="footer">

      <div class="footer-copyright">
          Copyright © 2015 - 2018 Wube Software - all rights reserved.
        </div>
        <div class="footer-menu">

          

          <a href="/terms-of-service" style="font-size: 11px;"> Terms of Service </a>
          <span style="font-size: 11px;"> | </span>
          

          <a href="/privacy-policy" style="font-size: 11px;"> Privacy </a>
          <span style="font-size: 11px;"> | </span>
          

          <a href="/imprint" style="font-size: 11px;"> Imprint </a>
          <span style="font-size: 11px;"> | </span>
          

          <a href="/presskit" style="font-size: 11px;"> Presskit </a>
          <span style="font-size: 11px;"> | </span>
          

          <a href="/faq" style="font-size: 11px;"> FAQ </a>
          <span style="font-size: 11px;"> | </span>
          

          <a href="/blog/rss" style="font-size: 11px;"> RSS </a>
          <span style="font-size: 11px;"> | </span>
          

          <a href="/jobs" style="font-size: 11px;">
            Jobs
          </a>
      </div>
    </div>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
  
  <script src="/static/js/raphael-min.js" type="text/javascript"></script>
  <script src="/static/js/factorio.min.js" type="text/javascript"></script>
  <script src="/static/lightbox/js/lightbox.min.js" type="text/javascript"></script>
  <script type="text/javascript">
   var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-115167276-1']);
        _gaq.push(['_trackPageview']);
        (function()
        {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
  </script>
 </body>
</html>