<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Factorio Friday Facts Wordcloud</title>
    <meta name="description" content="View Wordclouds for Factorio Friday Facts blog posts.">
    <meta name="author" content="fffbot">
    <style>
        body {
            font: 10pt sans-serif;
        }

        .container {
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            justify-content: flex-start;
            align-items: stretch;
            align-content: stretch;
        }

        .panel {
            flex-basis: auto;
            flex-grow: 0;
            flex-shrink: 1;
            align-self: auto;
            width: 100%;
            padding: 10px;
        }

        .ffflist {
            border: 1px solid red;
        }

        .cloud {
            border: 1px solid green;
        }

        .wordlist {
            border: 1px solid purple;
        }

        .ffflist > ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }
    </style>
    <script>
        const _config = {
            'per-line': false,
            'font': 'sans-serif',
            'spiral': 'archimedean' /*rectangular*/,
            'scale': 'log' /*log/sqrt/linear*/,
            'max': 250,
            'angle-count': 5,
            'angle-from': -60,
            'angle-to': 60
        };

        function config(key) {
            const val = _config[key];
            if (val === undefined) {
                throw new Error('Invalid config key ' + key);
            }
            return val;
        }

        function createLi(text, href) {
            const link = document.createElement('A');
            link.setAttribute('href', href);
            link.innerHTML = text;

            const li = document.createElement('LI');
            li.appendChild(link);
            return li;
        }

        function handleHashChange() {
            const num = location.hash.trim().substr(1);
            showCloudFor(num);
        }

        function clear(element) {
            while (element.lastChild) {
                element.removeChild(element.lastChild);
            }
        }

        function cell(text) {
            const cell = document.createElement('TD');
            cell.innerText = text;
            return cell;
        }

        function row(word, count) {
            const wordCell = cell(word);
            const countCell = cell(count);

            const row = document.createElement('TR');
            row.appendChild(wordCell);
            row.appendChild(countCell);
            return row;
        }

        function sumCounts(data) {
            const countsByWord = new Map();

            Object.values(data).forEach(item => {
                Object.entries(item.counts).forEach(([word, count]) => {
                    const cur = countsByWord.get(word) || 0;
                    countsByWord.set(word, cur + count);
                });
            });

            return countsByWord;
        }

        function showCloudFor(num) {
            const cloud = document.getElementById('cloud');

            if (num === 'overview' || num === '') {
                cloud.innerText = 'Overview :)';

                fillWordList(sumCounts(_data).entries());
            } else {
                const entry = _data[num];
                if (!entry || !entry.counts) {
                    cloud.innerText = 'No FFF found for ' + num;
                    return;
                }

                cloud.innerText = 'Would show cloud for ' + num + ' (' + entry.title + ')';

                fillWordList(Object.entries(entry.counts));
            }

            window.scroll(0, 0);
        }

        function fillWordList(entries) {
            const sorted = new Map([...entries].sort((a, b) => b[1] - a[1]));

            const wordList = document.getElementById('wordlist-table-body');
            clear(wordList);

            const allWords = [];
            for (const [word, count] of sorted.entries()) {
                wordList.appendChild(row(word, count));
                for (let i = 0; i < count; i++) {
                    allWords.push(word);
                }
            }
            parseText(allWords.join(' '));
        }

        function loadData() {
            fetch('all-counts.json')
                .then(resp => resp.ok ? resp.json() : Promise.reject(resp.statusText))
                .then(data => {
                    _data = data;

                    const fffList = document.getElementById('fff-list');
                    Object.keys(data).sort((a, b) => parseInt(b, 10) - parseInt(a, 10)).forEach(num => {
                        const entry = data[num];
                        const title = entry.title;
                        fffList.appendChild(createLi(title, '#' + num));
                    });

                    handleHashChange();
                })
                .catch(error => {
                    console.log('error!', error);
                    const cloud = document.getElementById('cloud');
                    cloud.innerText = 'Error loading word count data: ' + error;
                });
        }

        window.addEventListener("hashchange", handleHashChange, false);
        let _data;
        loadData();

    </script>
</head>

<body>

<div>
    <style>
        body {
            position: relative;
            font-family: "Helvetica Neue", sans-serif;
            width: 960px;
            margin: auto;
            margin-bottom: 1em;
            margin-top: 20px;
        }
        #presets a { border-left: solid #666 1px; padding: 0 10px; }
        #presets a.first { border-left: none; }
        #keyword { width: 300px; }
        #fetcher { width: 500px; }
        #keyword, #go { font-size: 1.5em; }
        #text { width: 100%; height: 100px; }
        p.copy { font-size: small; }
        #form { font-size: small; position: relative; }
        hr { border: none; border-bottom: solid #ccc 1px; }
        a.active { text-decoration: none; color: #000; font-weight: bold; cursor: text; }
        #angles line, #angles path, #angles circle { stroke: #666; }
        #angles text { fill: #333; }
        #angles path.drag { fill: #666; cursor: move; }
        #angles { text-align: center; margin: 0 auto; width: 350px; }
        #angles input, #max { width: 42px; }
    </style>

    <div id="vis"></div>

    <form id="form">

        <p style="position: absolute; right: 0; top: 0" id="status"></p>

        <div style="text-align: center">
            <div id="presets"></div>
            <div id="custom-area">
                <p><label for="text">Paste your text below!</label>
                <p><textarea id="text"></textarea>
                    <button id="go" type="submit">Go!</button>
            </div>
        </div>

        <hr>

        <div style="float: right; text-align: right">
            <p><label for="max">Number of words:</label> <input type="number" value="250" min="1" id="max">
            <p><label for="per-line"><input type="checkbox" id="per-line"> One word per line</label>
                <!--<p><label for="colours">Colours:</label> <a href="#" id="random-palette">get random palette</a>-->
            <p><label>Download:</label>
                <button id="download-svg">SVG</button><!-- |
    <a id="download-png" href="#">PNG</a>-->
        </div>

        <div style="float: left">
            <p><label>Spiral:</label>
                <label for="archimedean"><input type="radio" name="spiral" id="archimedean" value="archimedean" checked="checked"> Archimedean</label>
                <label for="rectangular"><input type="radio" name="spiral" id="rectangular" value="rectangular"> Rectangular</label>
            <p><label for="scale">Scale:</label>
                <label for="scale-log"><input type="radio" name="scale" id="scale-log" value="log" checked="checked"> log n</label>
                <label for="scale-sqrt"><input type="radio" name="scale" id="scale-sqrt" value="sqrt"> √n</label>
                <label for="scale-linear"><input type="radio" name="scale" id="scale-linear" value="linear"> n</label>
            <p><label for="font">Font:</label> <input type="text" id="font" value="Impact">
        </div>

        <div id="angles">
            <p><input type="number" id="angle-count" value="5" min="1"> <label for="angle-count">orientations</label>
                <label for="angle-from">from</label> <input type="number" id="angle-from" value="-60" min="-90" max="90"> °
                <label for="angle-to">to</label> <input type="number" id="angle-to" value="60" min="-90" max="90"> °
        </div>

        <hr style="clear: both">

        <p style="float: right"><a href="about/">How the Word Cloud Generator Works</a>.
        <p style="float: left">Copyright &copy; <a href="http://www.jasondavies.com/">Jason Davies</a> | <a href="../privacy/">Privacy Policy</a>. The generated word clouds may be used for any purpose.

    </form>

</div>

<div class="container">
    <div class="ffflist panel">
        <ul id="fff-list" style="border: 1px solid green">
            <li><a href="#overview">[Overview]</a></li>
        </ul>
    </div>

    <div class="cloud panel" id="cloud">
        Loading data...
    </div>

    <div class="wordlist panel">
        <table border="1">
            <thead>
            <tr>
                <th>Word</th>
                <th>Count</th>
            </tr>
            </thead>
            <tbody id="wordlist-table-body">
            </tbody>
        </table>
    </div>

</div>


</body>
</html>


<script src="ext/www.jasondavies.com_d3.min.js"></script>
<script src="ext/www.jasondavies.com_wordcloud_cloud.min.js"></script>
